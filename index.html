<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ÙˆÙƒØ§Ù„Ø© Ù†ÙˆØ± Ø§Ù„Ù…Ù†ØªØ¸Ø± - Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¨Ø§ØµØ§Øª</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f3f4f6;
      color: #111827;
    }

    .card {
      background: #ffffff;
      padding: 24px 20px 28px;
      width: 100%;
      max-width: 420px;
      border-radius: 18px;
      box-shadow: 0 14px 35px rgba(15, 23, 42, 0.15);
    }

    .card-header {
      text-align: center;
      margin-bottom: 18px;
    }

    .title {
      font-size: 20px;
      font-weight: 700;
      margin: 0 0 6px;
      color: #111827;
    }

    .subtitle {
      margin: 0;
      font-size: 13px;
      color: #6b7280;
    }

    .field-label {
      font-size: 13px;
      margin-bottom: 4px;
      color: #374151;
    }

    .field {
      margin-bottom: 14px;
    }

    input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
      direction: rtl;
    }

    input::placeholder {
      color: #9ca3af;
      font-size: 13px;
    }

    input:focus {
      border-color: #0284c7;
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.3);
    }

    .hint {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 2px;
    }

    .btn {
      width: 100%;
      border: none;
      border-radius: 999px;
      padding: 11px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.12s ease, background 0.12s ease;
    }

    .btn-primary {
      background: #059669;
      color: white;
      box-shadow: 0 8px 18px rgba(5, 150, 105, 0.35);
      margin-top: 4px;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(5, 150, 105, 0.4);
    }

    .btn-secondary {
      background: #ecfdf3;
      color: #15803d;
      border-radius: 999px;
      border: 1px solid #bbf7d0;
      margin-top: 10px;
    }

    .btn-secondary:hover {
      background: #dcfce7;
    }

    .footer-note {
      margin-top: 12px;
      font-size: 11px;
      color: #9ca3af;
      text-align: center;
    }

    .footer-note span {
      font-weight: 600;
      color: #16a34a;
    }

    /* ========== Modal (Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„) ========== */

    .modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .modal.open {
      display: flex;
    }

    .modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(15, 23, 42, 0.35);
    }

    .modal-content {
      position: relative;
      background: #ffffff;
      width: min(480px, 100% - 32px);
      max-height: 80vh;
      border-radius: 18px;
      padding: 16px 16px 14px;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.4);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .modal-title {
      font-size: 15px;
      font-weight: 700;
      color: #111827;
    }

    .modal-close {
      border: none;
      background: #f3f4f6;
      width: 26px;
      height: 26px;
      border-radius: 999px;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #6b7280;
    }

    .modal-close:hover {
      background: #e5e7eb;
    }

    .modal-toolbar {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }

    .search-input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      padding: 7px 12px;
      font-size: 13px;
      outline: none;
    }

    .search-input::placeholder {
      font-size: 12px;
      color: #9ca3af;
    }

    .clear-btn {
      border-radius: 999px;
      border: none;
      padding: 7px 10px;
      font-size: 12px;
      background: #fef2f2;
      color: #b91c1c;
      cursor: pointer;
      white-space: nowrap;
    }

    .clear-btn:hover {
      background: #fee2e2;
    }

    .modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 2px 1px 4px;
    }

    .history-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 9px;
      border-radius: 10px;
      background: #f9fafb;
      margin-bottom: 6px;
      font-size: 12px;
    }

    .history-main {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }

    .history-bus {
      padding: 2px 7px;
      border-radius: 999px;
      background: #e0f2fe;
      color: #0369a1;
      font-weight: 600;
      font-size: 11px;
    }

    .history-name {
      font-weight: 600;
      color: #111827;
    }

    .history-phone {
      color: #4b5563;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    .delete-item {
      border: none;
      background: transparent;
      color: #9ca3af;
      font-size: 14px;
      cursor: pointer;
      padding: 0 4px;
    }

    .delete-item:hover {
      color: #ef4444;
    }

    .empty-history {
      text-align: center;
      font-size: 12px;
      color: #9ca3af;
      margin-top: 20px;
    }

    @media (max-width: 480px) {
      .card {
        margin: 16px;
      }
    }
  </style>
</head>
<body>

  <div class="card">
    <div class="card-header">
      <h1 class="title">ÙˆÙƒØ§Ù„Ø© Ù†ÙˆØ± Ø§Ù„Ù…Ù†ØªØ¸Ø±</h1>
      <p class="subtitle">Ù†Ø¸Ø§Ù… Ø¥Ø±Ø³Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¨Ø§Øµ Ù„Ù„Ø²ÙˆØ§Ø±</p>
    </div>

    <div class="field">
      <div class="field-label">Ø§Ø³Ù… Ø§Ù„Ø²Ø§Ø¦Ø±:</div>
      <input id="visitorName" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø¬Ø¹ÙØ± Ø¹Ù„ÙŠ">
    </div>

    <div class="field">
      <div class="field-label">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„:</div>
      <input id="phoneNumber" type="text" placeholder="05XXXXXXXX Ø£Ùˆ 9665XXXXXXXX">
      <div class="hint">ÙŠÙ‚Ø¨Ù„ Ù Ù¥ / 5 / 966 / +966 / 00966 ÙˆØ¨Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø£Ùˆ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©.</div>
    </div>

    <div class="field">
      <div class="field-label">Ø±Ù‚Ù… Ø§Ù„Ø¨Ø§Øµ:</div>
      <input id="busNumber" type="text" placeholder="Ù…Ø«Ø§Ù„: 1">
    </div>

    <button class="btn btn-primary" onclick="sendWhatsApp()">Ø¥Ø±Ø³Ø§Ù„</button>
    <button class="btn btn-secondary" onclick="openHistory()">Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</button>

    <div class="footer-note">
      Ù…ÙØ·ÙˆØ± Ø®ØµÙŠØµÙ‹Ø§ Ù„Ø­Ù…Ù„Ø§Øª Ø§Ù„Ø²ÙˆØ§Ø± â€“ <span>MenuLink</span> ğŸ“²
    </div>
  </div>

  <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø³Ø¬Ù„ -->
  <div id="historyModal" class="modal">
    <div class="modal-backdrop" onclick="closeHistory()"></div>
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</div>
        <button class="modal-close" onclick="closeHistory()">âœ•</button>
      </div>

      <div class="modal-toolbar">
        <input
          type="text"
          class="search-input"
          placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø²Ø§Ø¦Ø±ØŒ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ØŒ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø¨Ø§Øµ..."
          oninput="searchHistory(this)"
        >
        <button class="clear-btn" onclick="clearHistory()">Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ ÙƒØ§Ù…Ù„Ù‹Ø§</button>
      </div>

      <div id="historyList" class="modal-body"></div>
    </div>
  </div>

  <script>
    // ØªØ­ÙˆÙŠÙ„ ÙƒÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©/Ø§Ù„ÙØ§Ø±Ø³ÙŠØ© â†’ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© + Ø­Ø°Ù Ø§Ù„Ø±Ù…ÙˆØ² ÙˆØ§Ù„Ù…Ø³Ø§ÙØ§Øª
    function normalizeDigits(str) {
      if (!str) return '';
      const arabic = 'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©';
      const persian = 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹';
      let out = '';

      for (const ch of str) {
        const i1 = arabic.indexOf(ch);
        if (i1 !== -1) { out += i1; continue; }

        const i2 = persian.indexOf(ch);
        if (i2 !== -1) { out += i2; continue; }

        if (ch >= '0' && ch <= '9') {
          out += ch;
          continue;
        }

        // Ù†ØªØ¬Ø§Ù‡Ù„ Ø£ÙŠ Ø±Ù…Ø² Ø¢Ø®Ø± (+ - Ù…Ø³Ø§ÙØ© ...)
      }
      return out;
    }

    // ØªØ±ØªÙŠØ¨ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø¥Ù„Ù‰ ØµÙŠØºØ© Ø³Ø¹ÙˆØ¯ÙŠØ© Ù…ÙˆØ­Ø¯Ø© 9665XXXXXXXX
    function formatSaudiPhone(raw) {
      let digits = normalizeDigits(raw);

      if (!digits) return null;

      // Ø´ÙŠÙ„ 00 Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯Ø©
      if (digits.startsWith('00')) digits = digits.slice(2);

      // Ø´ÙŠÙ„ 966 Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯Ø©
      if (digits.startsWith('966')) digits = digits.slice(3);

      // Ù„Ùˆ Ù…ÙƒØªÙˆØ¨Ø© 05XXXXXXXX Ù†Ø®Ù„ÙŠÙ‡Ø§ 5XXXXXXXX
      if (digits.startsWith('05')) digits = digits.slice(1);

      // Ø§Ù„Ø¢Ù† Ù„Ø§Ø²Ù… ØªØ¨Ø¯Ø£ Ø¨Ù€ 5 ÙˆØ·ÙˆÙ„Ù‡Ø§ 9 Ø£Ø±Ù‚Ø§Ù… (5 + 8)
      if (!digits.startsWith('5') || digits.length !== 9) {
        return null;
      }

      return '966' + digits; // Ù…Ø«Ø§Ù„: 9665XXXXXXXX
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ + Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³Ø¬Ù„
    function sendWhatsApp() {
      const nameInput  = document.getElementById('visitorName');
      const phoneInput = document.getElementById('phoneNumber');
      const busInput   = document.getElementById('busNumber');

      const name     = nameInput.value.trim();
      const rawPhone = phoneInput.value.trim();
      const rawBus   = busInput.value.trim();

      const busDigits  = normalizeDigits(rawBus);
      const phoneForWa = formatSaudiPhone(rawPhone);

      if (!name || !busDigits || !phoneForWa) {
        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø§Ø³Ù… Ø§Ù„Ø²Ø§Ø¦Ø±ØŒ Ø±Ù‚Ù… Ø§Ù„Ø¨Ø§ØµØŒ ÙˆØ±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.');
        return;
      }

      const bus = parseInt(busDigits, 10);
      if (isNaN(bus) || bus <= 0) {
        alert('Ø±Ù‚Ù… Ø§Ù„Ø¨Ø§Øµ ØºÙŠØ± ØµØ­ÙŠØ­.');
        return;
      }

      const message =
`Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ÙˆØ±Ø­Ù…Ø© Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø±ÙƒØ§ØªÙ‡ ğŸŒ¹

ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: ${name}
ğŸšŒ Ø±Ù‚Ù… Ø§Ù„Ø¨Ø§Øµ: ${bus}

Ù†ØªÙ…Ù†Ù‰ Ù„ÙƒÙ… Ø±Ø­Ù„Ø© Ù…ÙˆÙÙ‚Ø© Ù…Ø¹ *ÙˆÙƒØ§Ù„Ø© Ù†ÙˆØ± Ø§Ù„Ù…Ù†ØªØ¸Ø±*
ğŸ“² Ø®Ø¯Ù…Ø© MenuLink`;

      const url = `https://wa.me/${phoneForWa}?text=${encodeURIComponent(message)}`;
      window.open(url, '_blank');

      // Ù†Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³Ø¬Ù„
      saveToHistory({ name, phone: phoneForWa, bus });

      // Ù†ÙØ±Ù‘Øº Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
      nameInput.value = '';
      phoneInput.value = '';
      busInput.value = '';
    }

    /* ===================== Ø§Ù„Ø³Ø¬Ù„ (localStorage) ===================== */

    const HISTORY_KEY = 'noor-almontathar-history';

    function loadHistory() {
      const json = localStorage.getItem(HISTORY_KEY);
      if (!json) return [];
      try {
        return JSON.parse(json);
      } catch {
        return [];
      }
    }

    function saveHistory(list) {
      localStorage.setItem(HISTORY_KEY, JSON.stringify(list));
    }

    function saveToHistory(entry) {
      const list = loadHistory();
      list.unshift({
        ...entry,
        time: new Date().toISOString()
      });
      saveHistory(list);
      renderHistory();
    }

    function deleteHistoryItem(index) {
      const list = loadHistory();
      const item = list[index];
      if (!item) return;

      const ok = confirm(
        `Ù…ØªØ£ÙƒØ¯ ØªØ¨ØºÙ‰ ØªØ­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŸ\n\n` +
        `Ø§Ù„Ø§Ø³Ù…: ${item.name}\n` +
        `Ø§Ù„Ø¨Ø§Øµ: ${item.bus}\n` +
        `Ø§Ù„Ø¬ÙˆØ§Ù„: ${item.phone}`
      );
      if (!ok) return;

      list.splice(index, 1);
      saveHistory(list);
      renderHistory();
    }

    function clearHistory() {
      if (!confirm('Ù…ØªØ£ÙƒØ¯ ØªØ¨ØºÙ‰ ØªØ­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ ÙƒØ§Ù…Ù„Ù‹Ø§ØŸ')) return;
      localStorage.removeItem(HISTORY_KEY);
      renderHistory();
    }

    function renderHistory(filterText = '') {
      const list = loadHistory();
      const container = document.getElementById('historyList');
      if (!container) return;

      const term = filterText.trim().toLowerCase();
      container.innerHTML = '';

      let filtered = list;
      if (term) {
        filtered = list.filter(item =>
          (item.name  && item.name.toLowerCase().includes(term)) ||
          (item.phone && item.phone.includes(term)) ||
          (item.bus   && String(item.bus).includes(term))
        );
      }

      if (!filtered.length) {
        container.innerHTML = '<p class="empty-history">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</p>';
        return;
      }

      filtered.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'history-item';
        div.innerHTML = `
          <div class="history-main">
            <span class="history-bus">Ø¨Ø§Øµ ${item.bus}</span>
            <span class="history-name">${item.name}</span>
            <span class="history-phone">${item.phone}</span>
          </div>
          <button class="delete-item" data-index="${index}" title="Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø²Ø§Ø¦Ø±">âœ•</button>
        `;
        container.appendChild(div);
      });

      container.querySelectorAll('.delete-item').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const idx = parseInt(e.currentTarget.getAttribute('data-index'), 10);
          deleteHistoryItem(idx);
        });
      });
    }

    // ÙØªØ­ / Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø³Ø¬Ù„
    function openHistory() {
      const modal = document.getElementById('historyModal');
      if (!modal) return;
      modal.classList.add('open');
      renderHistory();
    }

    function closeHistory() {
      const modal = document.getElementById('historyModal');
      if (!modal) return;
      modal.classList.remove('open');
    }

    // Ø¨Ø­Ø« Ø¯Ø§Ø®Ù„ Ø§Ù„Ø³Ø¬Ù„
    function searchHistory(input) {
      renderHistory(input.value);
    }

    // Ù†Ø¬Ù‡Ø² Ø§Ù„Ø³Ø¬Ù„ Ø£ÙˆÙ„ Ù…Ø§ ØªÙØªØ­ Ø§Ù„ØµÙØ­Ø©
    document.addEventListener('DOMContentLoaded', () => {
      renderHistory();
    });
  </script>

</body>
</html>
