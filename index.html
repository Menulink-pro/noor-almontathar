<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ÙˆÙƒØ§Ù„Ø© Ù†ÙˆØ± Ø§Ù„Ù…Ù†ØªØ¸Ø± - Ù†Ø¸Ø§Ù… Ø±Ù‚Ù… Ø§Ù„Ø¨Ø§Øµ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f3f4f6;
      color: #111827;
    }

    .card {
      background: #ffffff;
      padding: 26px 22px 28px;
      width: 100%;
      max-width: 460px;
      border-radius: 20px;
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.18);
    }

    .card-header {
      text-align: center;
      margin-bottom: 20px;
    }

    .title {
      font-size: 22px;
      font-weight: 800;
      margin: 0 0 6px;
      color: #111827;
    }

    .subtitle {
      margin: 0;
      font-size: 14px;
      color: #6b7280;
    }

    .field {
      margin-bottom: 16px;
    }

    .field-label {
      font-size: 14px;
      margin-bottom: 4px;
      color: #374151;
    }

    input {
      width: 100%;
      padding: 11px 13px;
      border-radius: 12px;
      border: 1px solid #d1d5db;
      font-size: 15px;
      outline: none;
      direction: rtl;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }

    input::placeholder {
      color: #9ca3af;
      font-size: 13px;
    }

    input:focus {
      border-color: #0284c7;
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.35);
    }

    .btn {
      width: 100%;
      border: none;
      border-radius: 999px;
      padding: 11px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.12s ease, background 0.12s ease;
    }

    .btn-primary {
      background: #059669;
      color: white;
      box-shadow: 0 10px 22px rgba(5, 150, 105, 0.35);
      margin-top: 4px;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 26px rgba(5, 150, 105, 0.45);
    }

    .btn-secondary {
      background: #ecfdf3;
      color: #15803d;
      border-radius: 999px;
      border: 1px solid #bbf7d0;
      margin-top: 10px;
    }

    .btn-secondary:hover {
      background: #dcfce7;
    }

    .btn-ghost {
      margin-top: 8px;
      background: transparent;
      border: none;
      color: #6b7280;
      font-size: 13px;
      cursor: pointer;
      text-decoration: underline;
    }

    .footer-note {
      margin-top: 14px;
      font-size: 12px;
      color: #9ca3af;
      text-align: center;
    }

    .footer-note span {
      font-weight: 600;
      color: #16a34a;
    }

    @media (max-width: 480px) {
      .card {
        margin: 18px;
      }
    }

    /* ====== Ø§Ù„Ø³Ø¬Ù„ - ØµÙØ­Ø© Ø´ÙØ§ÙØ© ÙÙˆÙ‚ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ====== */
    .overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .overlay-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(15, 23, 42, 0.55);
    }

    .history-modal {
      position: relative;
      background: #ffffff;
      width: 100%;
      max-width: 520px;
      max-height: 80vh;
      border-radius: 18px;
      padding: 16px 18px 18px;
      box-shadow: 0 20px 50px rgba(15, 23, 42, 0.5);
      z-index: 60;
      display: flex;
      flex-direction: column;
    }

    .history-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .history-title {
      font-size: 15px;
      font-weight: 700;
      color: #111827;
    }

    .history-top-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .history-search {
      width: 170px;
      max-width: 48vw;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      padding: 6px 10px;
      font-size: 12px;
      outline: none;
    }

    .history-search::placeholder {
      font-size: 11px;
      color: #9ca3af;
    }

    .history-clear {
      border-radius: 999px;
      border: none;
      padding: 6px 10px;
      font-size: 11px;
      background: #fef2f2;
      color: #b91c1c;
      cursor: pointer;
      white-space: nowrap;
    }

    .history-clear:hover {
      background: #fee2e2;
    }

    .history-close {
      border: none;
      background: transparent;
      font-size: 18px;
      cursor: pointer;
      color: #9ca3af;
      margin-left: 4px;
    }

    .history-close:hover {
      color: #111827;
    }

    .history-content {
      flex: 1;
      overflow-y: auto;
      padding-top: 4px;
      border-top: 1px solid #e5e7eb;
      margin-top: 6px;
    }

    .bus-group {
      margin-bottom: 10px;
    }

    .bus-heading {
      font-size: 13px;
      font-weight: 700;
      color: #0369a1;
      margin: 6px 0 4px;
    }

    .history-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 7px 8px;
      border-radius: 10px;
      background: #f9fafb;
      margin-bottom: 5px;
      font-size: 12px;
    }

    .history-main {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }

    .history-name {
      font-weight: 600;
      color: #111827;
    }

    .history-phone {
      color: #4b5563;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    .delete-item {
      border: none;
      background: transparent;
      color: #9ca3af;
      font-size: 14px;
      cursor: pointer;
      padding: 0 4px;
    }

    .delete-item:hover {
      color: #ef4444;
    }

    .empty-history {
      text-align: center;
      font-size: 12px;
      color: #9ca3af;
      margin-top: 14px;
    }

    @media (max-width: 480px) {
      .history-modal {
        margin: 16px;
        max-height: 82vh;
      }
    }
  </style>
</head>
<body>

  <div class="card">
    <div class="card-header">
      <h1 class="title">ÙˆÙƒØ§Ù„Ø© Ù†ÙˆØ± Ø§Ù„Ù…Ù†ØªØ¸Ø±</h1>
      <p class="subtitle">Ù†Ø¸Ø§Ù… Ø¥Ø±Ø³Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¨Ø§Øµ Ù„Ù„Ø²ÙˆØ§Ø±</p>
    </div>

    <div class="field">
      <div class="field-label">Ø§Ø³Ù… Ø§Ù„Ø²Ø§Ø¦Ø±:</div>
      <input id="visitorName" type="text" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø²Ø§Ø¦Ø±">
    </div>

    <div class="field">
      <div class="field-label">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„:</div>
      <input id="phoneNumber" type="text" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„">
    </div>

    <div class="field">
      <div class="field-label">Ø±Ù‚Ù… Ø§Ù„Ø¨Ø§Øµ:</div>
      <input id="busNumber" type="text" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¨Ø§Øµ">
    </div>

    <button class="btn btn-primary" onclick="sendWhatsApp()">Ø¥Ø±Ø³Ø§Ù„</button>
    <button class="btn btn-secondary" onclick="toggleHistory()">Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</button>
    <button class="btn-ghost" onclick="clearForm()">Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„ âœ•</button>

    <div class="footer-note">
      Ù…Ø·ÙˆØ± Ø¨ÙˆØ§Ø³Ø·Ø© <span>MenuLink</span> ğŸ“²
    </div>
  </div>

  <!-- === Ù†Ø§ÙØ°Ø© Ø§Ù„Ø³Ø¬Ù„ ÙÙˆÙ‚ Ø§Ù„Ù…ÙˆÙ‚Ø¹ === -->
  <div id="historyOverlay" class="overlay">
    <div class="overlay-backdrop" onclick="closeHistory()"></div>

    <div class="history-modal">
      <div class="history-header">
        <div class="history-title">Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</div>
        <div class="history-top-actions">
          <input
            id="historySearch"
            class="history-search"
            type="text"
            placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… / Ø§Ù„Ø¬ÙˆØ§Ù„ / Ø§Ù„Ø¨Ø§Øµ"
            oninput="searchHistory(this)"
          >
          <button class="history-clear" onclick="clearHistory()">Ø­Ø°Ù Ø§Ù„ÙƒÙ„</button>
          <button class="history-close" onclick="closeHistory()">âœ•</button>
        </div>
      </div>

      <div id="historyContent" class="history-content"></div>
    </div>
  </div>

  <script>
    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©/Ø§Ù„ÙØ§Ø±Ø³ÙŠØ© Ø¥Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù… Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©
    function normalizeDigits(str) {
      if (!str) return '';
      const arabic = 'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©';
      const persian = 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹';
      let out = '';

      for (const ch of str) {
        const i1 = arabic.indexOf(ch);
        if (i1 !== -1) { out += i1; continue; }

        const i2 = persian.indexOf(ch);
        if (i2 !== -1) { out += i2; continue; }

        if (ch >= '0' && ch <= '9') {
          out += ch;
          continue;
        }
        // Ù†ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø±Ù…ÙˆØ² Ù…Ø«Ù„ + - Ù…Ø³Ø§ÙØ©
      }
      return out;
    }

    // Ø¶Ø¨Ø· Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø¥Ù„Ù‰ ØµÙŠØºØ© Ø³Ø¹ÙˆØ¯ÙŠØ© 9665XXXXXXXX
    function formatSaudiPhone(raw) {
      let digits = normalizeDigits(raw);
      if (!digits) return null;

      if (digits.startsWith('00')) digits = digits.slice(2);
      if (digits.startsWith('966')) digits = digits.slice(3);
      if (digits.startsWith('05')) digits = digits.slice(1);

      if (!digits.startsWith('5') || digits.length !== 9) {
        return null;
      }
      return '966' + digits;
    }

    function clearForm() {
      document.getElementById('visitorName').value = '';
      document.getElementById('phoneNumber').value = '';
      document.getElementById('busNumber').value = '';
    }

    function sendWhatsApp() {
      const nameInput  = document.getElementById('visitorName');
      const phoneInput = document.getElementById('phoneNumber');
      const busInput   = document.getElementById('busNumber');

      const name     = nameInput.value.trim();
      const rawPhone = phoneInput.value.trim();
      const rawBus   = busInput.value.trim();

      const busDigits  = normalizeDigits(rawBus);
      const phoneForWa = formatSaudiPhone(rawPhone);

      if (!name || !busDigits || !phoneForWa) {
        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø§Ø³Ù… Ø§Ù„Ø²Ø§Ø¦Ø±ØŒ Ø±Ù‚Ù… Ø§Ù„Ø¨Ø§ØµØŒ ÙˆØ±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.');
        return;
      }

      const bus = parseInt(busDigits, 10);
      if (isNaN(bus) || bus <= 0) {
        alert('Ø±Ù‚Ù… Ø§Ù„Ø¨Ø§Øµ ØºÙŠØ± ØµØ­ÙŠØ­.');
        return;
      }

      const message =
`Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ÙˆØ±Ø­Ù…Ø© Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø±ÙƒØ§ØªÙ‡ ğŸŒ¹

ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: ${name}
ğŸšŒ Ø±Ù‚Ù… Ø§Ù„Ø¨Ø§Øµ: ${bus}

Ù†ØªÙ…Ù†Ù‰ Ù„ÙƒÙ… Ø±Ø­Ù„Ø© Ù…ÙˆÙÙ‚Ø© Ù…Ø¹ *ÙˆÙƒØ§Ù„Ø© Ù†ÙˆØ± Ø§Ù„Ù…Ù†ØªØ¸Ø±*
ğŸ“² Ø®Ø¯Ù…Ø© MenuLink`;

      const url = `https://wa.me/${phoneForWa}?text=${encodeURIComponent(message)}`;
      window.open(url, '_blank');

      // Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³Ø¬Ù„
      saveToHistory({ id: Date.now() + '_' + Math.random().toString(16).slice(2), name, phone: phoneForWa, bus });

      // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„
      clearForm();
    }

    /* ====== Ø§Ù„Ø³Ø¬Ù„ (LocalStorage) ====== */

    const HISTORY_KEY = 'noor-almontathar-history';

    function loadHistory() {
      const json = localStorage.getItem(HISTORY_KEY);
      if (!json) return [];
      try { return JSON.parse(json); } catch { return []; }
    }

    function saveHistory(list) {
      localStorage.setItem(HISTORY_KEY, JSON.stringify(list));
    }

    function saveToHistory(entry) {
      const list = loadHistory();
      // Ù„Ùˆ Ù…Ø§ ÙÙŠÙ‡ id (Ø¥Ø±Ø³Ø§Ù„Ø§Øª Ù‚Ø¯ÙŠÙ…Ø©) Ù†Ø³ÙˆÙŠ Ù„Ù‡
      if (!entry.id) {
        entry.id = Date.now() + '_' + Math.random().toString(16).slice(2);
      }
      list.push(entry);
      saveHistory(list);
    }

    function deleteHistoryItemById(id) {
      const list = loadHistory();
      const item = list.find(x => x.id === id);
      if (!item) return;

      const ok = confirm(
        `Ù…ØªØ£ÙƒØ¯ ØªØ¨ØºÙ‰ ØªØ­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŸ\n\n` +
        `Ø§Ù„Ø§Ø³Ù…: ${item.name}\n` +
        `Ø§Ù„Ø¨Ø§Øµ: ${item.bus}\n` +
        `Ø§Ù„Ø¬ÙˆØ§Ù„: ${item.phone}`
      );
      if (!ok) return;

      const newList = list.filter(x => x.id !== id);
      saveHistory(newList);
      renderHistory(currentSearchTerm);
    }

    function clearHistory() {
      if (!confirm('Ù…ØªØ£ÙƒØ¯ ØªØ¨ØºÙ‰ ØªØ­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ ÙƒØ§Ù…Ù„Ù‹Ø§ØŸ')) return;
      localStorage.removeItem(HISTORY_KEY);
      renderHistory(currentSearchTerm);
    }

    let currentSearchTerm = '';

    function renderHistory(filterText = '') {
      const all = loadHistory();
      const container = document.getElementById('historyContent');
      if (!container) return;

      currentSearchTerm = filterText.trim().toLowerCase();
      container.innerHTML = '';

      // ÙÙ„ØªØ±Ø©
      let filtered = all;
      if (currentSearchTerm) {
        filtered = all.filter(item =>
          (item.name  && item.name.toLowerCase().includes(currentSearchTerm)) ||
          (item.phone && item.phone.includes(currentSearchTerm)) ||
          (item.bus   && String(item.bus).includes(currentSearchTerm))
        );
      }

      if (!filtered.length) {
        container.innerHTML = '<p class="empty-history">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</p>';
        return;
      }

      // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø±Ù‚Ù… Ø§Ù„Ø¨Ø§Øµ Ø«Ù… Ø§Ù„Ø£Ù‚Ø¯Ù… ÙØ§Ù„Ø£Ø­Ø¯Ø« Ø¯Ø§Ø®Ù„ ÙƒÙ„ Ø¨Ø§Øµ
      filtered.sort((a, b) => {
        const ab = parseInt(a.bus, 10) || 0;
        const bb = parseInt(b.bus, 10) || 0;
        if (ab !== bb) return ab - bb;
        return 0;
      });

      // ØªØ¬Ù…ÙŠØ¹ Ø­Ø³Ø¨ Ø§Ù„Ø¨Ø§Øµ
      const groups = {};
      filtered.forEach(item => {
        const bus = item.bus || '?';
        if (!groups[bus]) groups[bus] = [];
        groups[bus].push(item);
      });

      Object.keys(groups).forEach(busNum => {
        const groupDiv = document.createElement('div');
        groupDiv.className = 'bus-group';

        const heading = document.createElement('div');
        heading.className = 'bus-heading';
        heading.textContent = `Ø¨Ø§Øµ ${busNum}`;
        groupDiv.appendChild(heading);

        groups[busNum].forEach(item => {
          const row = document.createElement('div');
          row.className = 'history-item';
          row.innerHTML = `
            <div class="history-main">
              <span class="history-name">${item.name}</span>
              <span class="history-phone">${item.phone}</span>
            </div>
            <button class="delete-item" title="Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø²Ø§Ø¦Ø±">âœ•</button>
          `;
          row.querySelector('.delete-item').addEventListener('click', () => {
            deleteHistoryItemById(item.id);
          });
          groupDiv.appendChild(row);
        });

        container.appendChild(groupDiv);
      });
    }

    function toggleHistory() {
      const overlay = document.getElementById('historyOverlay');
      if (!overlay) return;
      const isHidden = overlay.style.display === 'none' || overlay.style.display === '';
      if (isHidden) {
        overlay.style.display = 'flex';
        renderHistory(currentSearchTerm);
      } else {
        overlay.style.display = 'none';
      }
    }

    function closeHistory() {
      const overlay = document.getElementById('historyOverlay');
      if (overlay) overlay.style.display = 'none';
    }

    function searchHistory(input) {
      renderHistory(input.value);
    }

    document.addEventListener('DOMContentLoaded', () => {
      // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø³Ø¬Ù„ Ù„Ùˆ ÙØªØ­ØªÙ‡ Ø£ÙˆÙ„ Ù…Ø±Ø©
      renderHistory('');
    });
  </script>

</body>
</html>
